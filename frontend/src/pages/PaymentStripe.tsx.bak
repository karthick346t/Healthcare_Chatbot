import React, { useState, useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { HiLockClosed, HiShieldCheck, HiCalendar } from 'react-icons/hi';
import { loadStripe } from '@stripe/stripe-js';
import { Elements, PaymentElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { appointmentApi } from '../services/appointmentApi';

// Initialize Stripe (REPLACE WITH YOUR PUBLISHABLE KEY)
// Ideally this comes from env: import.meta.env.VITE_STRIPE_PUBLIC_KEY
const stripePromise = loadStripe('pk_test_51P0JbASGjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0kXjXh0kK0k'); 
// NOTE: The above key is a PLACEHOLDER. User must replace it.

const CheckoutForm = ({ appointmentDetails, clientSecret }: { appointmentDetails: any, clientSecret: string }) => {
    const stripe = useStripe();
    const elements = useElements();
    const navigate = useNavigate();
    
    const [message, setMessage] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(false);

    useEffect(() => {
        if (!stripe) return;

        const clientSecretParam = new URLSearchParams(window.location.search).get(
            "payment_intent_client_secret"
        );

        if (!clientSecretParam) return;

        stripe.retrievePaymentIntent(clientSecretParam).then(({ paymentIntent }) => {
            switch (paymentIntent?.status) {
                case "succeeded":
                    setMessage("Payment succeeded!");
                    break;
                case "processing":
                    setMessage("Your payment is processing.");
                    break;
                case "requires_payment_method":
                    setMessage("Your payment was not successful, please try again.");
                    break;
                default:
                    setMessage("Something went wrong.");
                    break;
            }
        });
    }, [stripe]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (!stripe || !elements) {
            return;
        }

        setIsLoading(true);

        // 1. Confirm Payment
        const { error, paymentIntent } = await stripe.confirmPayment({
            elements,
            redirect: "if_required", // Handle redirect manually to save booking first
        });

        if (error) {
            setMessage(error.message || "An unexpected error occurred.");
            setIsLoading(false);
        } else if (paymentIntent && paymentIntent.status === "succeeded") {
            // 2. Payment Succeeded -> Book Appointment
            try {
                const bookingData = {
                    patientName: appointmentDetails.patientDetails.name,
                    patientAge: parseInt(appointmentDetails.patientDetails.age),
                    patientGender: appointmentDetails.patientDetails.gender,
                    patientAddress: appointmentDetails.patientDetails.address,
                    problem: appointmentDetails.patientDetails.problem,
                    hospitalId: appointmentDetails.hospital._id,
                    doctorId: appointmentDetails.doctor._id,
                    appointmentDate: appointmentDetails.date,
                    // appointmentTime: appointmentDetails.timeSlot // Add if backend supports
                };

                const result = await appointmentApi.bookAppointment(bookingData);

                // 3. Navigate to Success
                navigate('/appointments', { 
                    state: { 
                        step: 4, 
                        bookingResult: result 
                    } 
                });
            } catch (err: any) {
                setMessage("Payment succeeded but booking failed: " + err.message);
            } finally {
                setIsLoading(false);
            }
        } else {
            setMessage("Payment Processing...");
            setIsLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-6">
            <PaymentElement id="payment-element" options={{ layout: "tabs" }} />
            
            <button 
                disabled={isLoading || !stripe || !elements} 
                id="submit"
                className="w-full py-4 mt-4 bg-neutral-900 text-white rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {isLoading ? (
                    <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                ) : (
                    "Pay now"
                )}
            </button>
            
            {message && (
                <div id="payment-message" className="text-sm text-red-500 font-medium text-center bg-red-50 p-3 rounded-lg border border-red-100">
                    {message}
                </div>
            )}
        </form>
    );
};

export default function Payment() {
    const navigate = useNavigate();
    const location = useLocation();
    const { appointmentDetails } = location.state || {};
    
    const [clientSecret, setClientSecret] = useState("");

    // If accessed directly without appointment data, redirect back
    useEffect(() => {
        if (!appointmentDetails) {
             navigate('/appointments'); 
             return;
        }

        // Create PaymentIntent as soon as the page loads
        fetch("http://localhost:4000/api/payment/create-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount: 50, currency: "usd" }), // $50.00
        })
        .then((res) => res.json())
        .then((data) => setClientSecret(data.clientSecret))
        .catch((err) => console.error("Error creating payment intent:", err));

    }, [appointmentDetails, navigate]);

    const appearance = {
        theme: 'stripe' as const,
        variables: {
            colorPrimary: '#06b6d4', // Cyan-500
            colorBackground: '#ffffff',
            colorText: '#171717',
        },
    };
    const options = {
        clientSecret,
        appearance,
    };

    return (
        <div className="min-h-[calc(100vh-6rem)] flex items-center justify-center p-4">
            <div className="flex flex-col lg:flex-row gap-8 max-w-5xl w-full">
                
                {/* Left Side: Order Summary */}
                <div className="flex-1 space-y-6">
                    <div>
                        <h1 className="text-4xl font-bold text-neutral-800 mb-2">Secure Checkout</h1>
                        <p className="text-neutral-500">Complete your payment to confirm your appointment.</p>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 space-y-4">
                        <div className="flex justify-between items-center pb-4 border-b border-gray-100">
                            <span className="text-neutral-500 font-medium">Consultation Fee</span>
                            <span className="text-xl font-bold text-neutral-800">$50.00</span>
                        </div>
                        <div className="space-y-3">
                            <div className="flex items-center gap-3 text-sm text-neutral-600">
                                <div className="w-8 h-8 rounded-full bg-cyan-50 flex items-center justify-center text-cyan-600">
                                    <HiShieldCheck />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-neutral-800">Doctor</p>
                                    <p>{appointmentDetails?.doctor?.name || "Dr. Sarah Wilson"}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 text-sm text-neutral-600">
                                <div className="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                    <HiCalendar />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-neutral-800">Date & Time</p>
                                    <p>{appointmentDetails?.date ? new Date(appointmentDetails.date).toLocaleDateString() : "Oct 24, 2024"} â€¢ {appointmentDetails?.timeSlot || "10:00 AM"}</p>
                                </div>
                            </div>
                        </div>
                        <div className="pt-4 flex items-center gap-2 text-xs text-green-600 bg-green-50 p-3 rounded-xl border border-green-100">
                            <HiLockClosed />
                            <span>Payments are SSL encrypted and 100% secure via Stripe.</span>
                        </div>
                    </div>
                </div>

                {/* Right Side: Stripe Elements */}
                <div className="flex-1">
                    <div className="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 relative overflow-hidden h-full">
                        {clientSecret ? (
                            <Elements options={options} stripe={stripePromise}>
                                <CheckoutForm appointmentDetails={appointmentDetails} clientSecret={clientSecret} />
                            </Elements>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full min-h-[300px]">
                                <div className="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <p className="text-neutral-500">Initializing Secure Payment...</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
